# Phoenix Navbar

This rewrite of the navbar is not Velocity-specific.  It has concepts of Suite & Product.  The configuration for the Suite defines logo, color and options.

# Themeing the navbar for new suites

See [Themes](./Themes.md)

## For local development

See [Local Development](./LocalDevelopment.md)

## Application Usage

## 2.3.0
Datadog Realtime User Metric (RUM) data is now being sent by default.  See below for setting to modify this behavior.

## 2.0.0
There are no breaking changes in the public API - only in how the navbar is fetched and installed. Upgrading the navbar should require no work from you, as long as the current suite is using at least `1.1.24` or later in production. As of this time, this includes the Velocity, Velocity-Beta, and Devtools suites.

If you're using a different suite, please check with the suite owner to see the version of the navbar currently in production.

## Before getting started with the navbar - A local ocelot instance is now _expected_ when developing Phoenix Applications.

For more information on running your own local ocelot instance, please [click here](https://devtools-np.bayer.com/docs/gateway/ocelot/running-locally/).

### Why do I need to run a local ocelot instance?

One of the most common question we get is around auth tokens. Teams are developing their apps while relying on cookie flow, without knowing that they're making calls too early.

A local ocelot ensures that your app is running with proper
authorization/authentication.

---
## Usage Example

Here's a pretty straightforward example of installing the navbar, then
running your application.

``` javascript
import navbar from '@monsantoit/phoenix-navbar'
import application from './application'

navbar.install({
    element: document.querySelector('.nav'),
    suiteId: 'velocity',         // get your suiteId and productId from
    productId: 'you-product-id', // http://devtools.bayer.com/navigation
})
.then(() => {
    // Once installed, auth token support will be enabled by the navbar.
    // Don't make any calls to remote services until this point.
    application.start()
})
.catch((err) => {
    // Errors thrown as part of installation will likely be from invalid
    // auth tokens. Be sure to run a local ocelot instance to avoid this.
    console.error(err)
})
```

Additional options for navbar installation can be seen below.

### Navbar Install Options

| Option        | Default  | Description  |
| ------------- |:----:|-----|
| element       | - | The DOM element that the nav bar should be attached to.  This element shouldn't be part of an existing virtual dom |
| suiteId       | - | The id of the suite as configured in the Phoenix navigation UI.  This is just a fallback for local development.  Under normal running conditions, the suiteId will be derived from the hostname |
| productId     | - | The id of the product as configured in the Phoenix navigation UI |
| useMiniSearch | true | Whether or not to use the built-in mini search dropdown. Setting false assumes your app will handle fetching, and displaying results. (See also: `Events`, below) |
| pinned | false | If pinned, the navbar will always be open.  Keep in mind this setting must be consistent for all pages in the application. |
| menu | - | By default menu configuration comes from the Phoenix navigation service.  This option overrides this setting for the product.  The menu may only be two levels deep.  The top level must have unique names, and the second level must have unique URLs. See below for detailed menu configuration |
| navbarVersion | - | String. Sets the navbar version to fetch, ignoring the remote config. Versions are typically semver, but you can also use `candidate`/`latest` for testing against upcoming releases. |
| cookieName | - | The name of the cookie to look for when enabling auth token support. Not required, but can speed up service calls.
| disableReduxDevtools | false | Allows you to disable the navbar's state/actions/reducers from connecting to the browser's redux devtools
| datadog.appName | - | Used to seperate out Products in Datadog down to distinct UI's (optional).  When not specified it will use Product-Id.
| datadog.version | - | When supplied this is sent to Datadog, this can be used to contrast RUM metrics in a Blue/Green setup or compare traffic characteristics (response times) between versions. (optional)
| datadog.disable | false | Allows you to disable sending any RUM metrics to Datadog
| datadog.enableLocal | false | Allows for the sending of RUM metrics when running locally
| datadog.disableTrace | false | Datadog by default sends trace data
| datadog.disableUser | false | Datadog by default sends userid information
| datadog.allowedTracingOrigins | [] | *.bayer.com, suitebaseUrl are always passed, A list of request origins used to inject tracing headers.
| datadog.sampleRate | 100 | The percentage of sessions to track: 100 for all, 0 for none. Only tracked sessions send rum events.
| datadog.completeOverride | - | Override based on Datadog docs https://docs.datadoghq.com/real_user_monitoring/browser/
| supportedBrowsers | {'chrome': true, 'firefox': true, 'safari': true, 'edge-chromium': true} | Object of browsers your Web UI supports or not. Add a key with value of true to add to the list. Set a key's value to false to remove from the list. List of browsers can be found here: https://github.com/DamonOehlman/detect-browser/blob/master/src/index.ts (line 67 as of addition of this feature)

## Static Menu Configuration

Static menu configuration allows SPA-like control at the product level. When fully
configured, users can navigate between workflows of a product without reloading
the page.

Providing static menu configuration will replace the entire configuration for
that product, so it's only recommended when a product has a single deployable.

For hooking into navigation events, see "Events and Subscriptions", below.

### Section Options
A `section` is a grouping of `location`s for a product.

| Option | Default | Description |
| ------ | ------- | ----------- |
| id | "" | The id for the section
| title | "" | The display name for the section |
| transparent | false | a transparent section places all children at the top level |
| children | [] | a list of `locations`. See Location Options |

### Location Options
A `location` represents data about an individual product workflow.

| Option | Default | Description |
| ------ | ------- | ----------- |
| id | "" | The id for the location
| title | "" | The display name for the location |
| url | "" | the path to this location |



### Example Configuration

``` javascript
const staticMenuConfig = [
    {
        title: 'Section With Children',
        children: [
            {
                title: 'A workflow',
                url: '/custom/workflow-a',
            },
            {
                title: 'Another Workflow',
                url: '/custom/workflow-b',
            }
        ],
    },
    {
        transparent: true, // puts children at root level.
        children: [
            {
                title: 'Root Workflow',
                url: '/custom/workflow-c',
            },
            {
                title: 'Another Root Workflow',
                url: '/custom/workflow-d',
            },
        ]
    }
]
```

## Events, and Subscriptions
The navbar provides a series of hooks for subscribing and interacting with the navbar.


### Event List

| Event | payload | Triggered By |
| ---- | ----     | ---          |
| NAVIGATE | `{ url: String, title: String }` | The user has clicked on a menu location, and wishes to navigate to that workflow. |
| UPDATE_SEARCH_INPUT | `{ value: String, event: Object}` | Search Input has changed
| DISPATCH_INSTALLED | `{ dispatch: Dispatcher }` | The navbar has been initialized, and the dispatcher is ready. |
| SHOW_SUPPORT_DIALOG | `{ metadata }` | The search dialog has been opened, this hook is for adding in additional metadata. |

### Subscriptions
You can subscribe to events as part of the navbar installation.

``` javascript
const actions = require('./actions')
const config = require('./config')
const navbar = require('@monsantoit/phoenix-navbar')

navbar
.on("NAVIGATE", actions.handleLocation)
.on("UPDATE_SEARCH_INPUT", actions.handleSearchChange)
.on("DISPATCH_INSTALLED", actions.handleDispatch)
.on("SHOW_SUPPORT_DIALOG", actions.handleShowSupportDialog)
.install(config.navbar)
.then(() => {
    // whatever you need to do.
})
```

Once installed, additional uses of `.on` will be ignored. If you need to subscribe post-install, use dispatch.subscribe() to listen to events.

Be sure to clean up unused handlers!

If you need additional event hooks, or navbar control, talk with us, and we'll see what we can expose.

### Dispatch changes

 A few programatic commands are available to grant control of the navbar.
 These will only be available post-installation.

``` javascript

import { dispatch } from '@monsantoit/phoenix-navbar'

dispatch.navigate({url, title}) // navbar

const subscription = () => {
    console.log("Subscribed!")
}

dispatch.subscribe("UPDATE_SEARCH_INPUT", subscribed) // use the same callback to subscribe
dispatch.unsubscribe("UPDATE_SEARCH_INPUT", subscribed) // ... and unsubscribe.

```

| Action | Params | Triggers                                                                                                                                                                                                                                                                                                                                                                     |
| ------ | ------ |------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| subscribe | action, callback | Subscribes a callback to an action. Pass the same callback in to unsubscribe.                                                                                                                                                                                                                                                                                                |
| unsubscribe | action, callback | Unsubscribes a callback to an action. Must be the same callback passed in.                                                                                                                                                                                                                                                                                                   |
| navigate | url, title, event | Keep the navbar in sync with your SPA. Static menu configurations can specify 'static: true' on the location, or the listener can `preventDefault()` on the provided event.                                                                                                                                                                                                  |
| promptUserForSupportTicket | {logs, metadata, prompt} | Prompts the user to enter a support ticket.  Useful when catching an unexpected error.  For usability reasons, do not trigger the dialog automatically.  Present the user with an error and an option to open the dialog and submit a ticket.  This feature relies on configuration in the product's support section in the Navigation UI. See below for more info on params |
| promptUserForFeedback | {} | Prompts the user for feedback using the standard dialog                                                                                                                                                                                                                                                                                                                      |
| promptUserForFeedbackCampaign | campaignId | Prompts the user for feedback using the standard dialog - dialog will only display if the campaign is active and the user is eligable (hasn't opted-out). The function is async and resolves when the dialog is dismissed (or skipped). |
| triggerBrowserSupportIssue | | Triggers a warning that the user's browser isn't supported (see below) |


### Supported Browsers

The supportedBrowsers flag (documented above) will check that the user is on an appropriate brand of browser, but the target version is not checked. To aid with this, we've provided a callback to display the 'unsupported browser' warning based on available browser features.  Here's an example:

```
if (!crypto.randomUUID) {
   dispatch.triggerBrowserSupportIssue()
}
```

---

#### promptUserForSupportTicket params
The method takes in an optional parameter object containing the following values (both are optional):
* logs - Should be a string, but can be an Error object as well.
* metadata - Array of objects formatted {key, value}.
* prompt - Options for the actual prompt. Currently one option
    * additionalText - Any custom text you want added to the description area
Note that if you pass in malformed data to these parameters, the user prompt will still occur. The malformed data will be trimmed out and not passed along, a warning will appear in your console when this happens.

## Developer documentation

### Publishing to NPM
Our jenkins build creates a release-candidate on every push to master. Do not release locally.
