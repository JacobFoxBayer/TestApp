const _ = require('lodash')
const getSuiteStylesheeUrl = require('./getSuiteStylesheetUrl')

const prependSlash = (str) => {
    if (!str.startsWith('/')) {
        return `/${str}`
    }
    return str
}

const genI18N = (i18n) => {
    if (i18n) {
        return `
<script>
    window.MonI18N = ${JSON.stringify(i18n)}
</script>
`.trim()
    }
    return ''
}

const trimIfAvailable = (text) => {
    if (text) {
        return text.trim()
    }
    return ''
}

module.exports = (appBaseUrl, title, suite, options = {}) => {
    const lightningExpress = options.lightningExpress ? '.js' : ''
    const navbarStylesHref =
        _.get(suite, 'navbarStylesUrl', false) ||
        `https://phoenix-tools.io/assets/cached/${_.get(suite, 'id', suite)}/styles/navbar.css`
    const faviconHref = _.get(suite, 'faviconUrl', false) || 'data:;base64,iVBORw0KGgo='
    const baseUrl = prependSlash(appBaseUrl)
    let fullHeadHtml = `
${genI18N(options.i18n)}
${trimIfAvailable(options.headHtml)}`.trim()
    if (!_.isEmpty(fullHeadHtml)) {
        fullHeadHtml = `\n${fullHeadHtml}`
    }
    let bodyHtml = trimIfAvailable(options.bodyHtml)
    if (!_.isEmpty(bodyHtml)) {
        bodyHtml = `\n${bodyHtml}`
    }
    const appStylesheet = options.appStyleSuiteSpecific ? _.get(suite, 'id', suite) : 'style'
    const bodyClasses = _.get(options, 'classes', 'navbar-above')
    const response = `
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
<title>${title}</title>
<link rel="icon" href="${faviconHref}">
<link rel="stylesheet" href="${getSuiteStylesheeUrl(_.get(suite, 'id', suite), options)}"/>
<link rel="stylesheet" href="${navbarStylesHref}"/>
<link rel="stylesheet" href="${baseUrl}/styles/${appStylesheet}.css">${fullHeadHtml}
</head>
        <body class="${bodyClasses}">
            <div class="nav"></div>
            <div class="contents"></div>
            <script type="text/javascript" src="${baseUrl}/service-bindings${lightningExpress}"></script>
            <script type="text/javascript">window.phoenix.suiteId = "${_.get(
                suite,
                'id',
                suite
            )}"</script>
            <script type="text/javascript" src="${baseUrl}/scripts/bundle.js"></script>${bodyHtml}
        </body>
</html>`.trim()
    global.indexHtml = response
    return response
}
