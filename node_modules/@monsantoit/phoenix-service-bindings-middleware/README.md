# Phoenix Service Binding Middleware

An express middleware that generates a script to flesh out items on the `window.phoenix` namespace.

The middleware currently sets values for the following properties:
* `window.phoenix.serviceBindings`
* `window.phoenix.localDevelopment`
* `window.phoenix.environment`

These properties are used by the `@monsantoit/phoenix-navbar` and the `@monsantoit/profile-client` libraries to fetch data from the appropriate environments.

Each property is generated based on your app's Cloudfoundry service bindings, any default bindings provided, and the `NODE_ENV` environment variable, while preventing sensitive values from reaching the client.

By default, values are automatically provided for core phoenix services (preferences/navigation/messaging/profile/feedback), but only for local development. See complete setup instructions below.

> **Note** - this library is not designed to be used on on the UI, except for isomorphic/server-side rendering.

## API
The module exports a function that takes two arguments, and returns an `express` middleware:

### **serviceBindings(defaultBindings: _Object_, flags: _Object_)**

- `defaultBindings:` An object of default values for `window.phoenix.serviceBindings`. Primarily used for local development. All values provided here will be overriden by any matching bindings on local development. Each binding should have a value in one of the following formats:
    - `{url: "http://yoururl.com}`
    - `{value: "somevalue"}`
- `flags:` An object of keys and values, as needed by your app. Anything passed in here will be added to the `window.phoenix` object, and requires no specific format.

## Example Middleware Configuration:

``` javascript

// if VCAP_SERVICES is not set then default values are used
const express = require('express')
const serviceBindings = require('@monsantoit/phoenix-service-bindings-middleware');

const app = express();
const appBaseUrl = '/my-app';
const defaultBindings = {
  'example-url': {
    url: 'http://example.phoenix-tools-np.io',
    username: 'this will be ignored',
    password: 'will also be ignored',
  }
};

// this will return the generated values at /my-app/service-bindings
app.use(`${appBaseUrl}/service-bindings`, serviceBindings(defaultBindings))

// ... the rest of your app
```

### Example HTML

``` html
<html>
    <head>
        <!-- snip -->
    </head>
    <body>
        <div class='nav'><!-- navbar --></div>
        <div class='container'><!-- mount app here --></div>
        <!-- The service bindings script should match the path your provided the app.use -->
        <script type='text/javascript' src='/my-app/service-bindings'/>
        <!-- Your app bundle - must come second! -->
        <script type='text/javascript' src='/my-app/scripts/bundle.js'/>
    </body>
</html>
```

### Example output, usable by your app

``` javascript
console.log(window.phoenix)
{
    localDevelopment: false,
    localOcelot: false,
    environment: nonProd,
    serviceBindings: {
        "home-url": "https://phoenix-tools-np.io/home",
        "preferences-url": "https://preferences.phoenix-tools-np.io",
        "navigation-url": "https://navigation.phoenix-tools-np.io",
        "messaging-url": "https://messaging.phoenix-tools-np.io",
        "profile-url": "https://profile.phoenix-tools-np.io",
        "user-feedback-url": "https://user-feedback.phoenix-tools-np.io",
        "example-url":"https://example.phoenix-tools-np.io"
    }
};
```

## Setup


### Fargate and non-CloudFoundry deployment targets
When using this library outside of cloudfoundry, simply pass in your compiled bindings. You'll need to provide phoenix home bindings, at the minimum

#### Nonprod:
```
serviceBindings({
    'phoenix-home': { url: 'phoenix-tools-np.io', env:'NonProd' }
})
```

#### Prod:
```
serviceBindings({
    'phoenix-home': { url: 'phoenix-tools.io', env:'Prod' }
})
```

### Cloudfoundry - add a binding for phoenix-home

When deploying, you must include the **phoenix-home** service binding. This will ensure that the default values (environment, local development, core phoenix service bindings) will be populated correctly.

When creating the binding, make sure to set both **`value`** and **`env`** properties. This binding only needs to be created once per cloudfoundry org.

``` bash
# non-prod
cf cups phoenix-home -p '{"alias":"phoenix-home","value":"phoenix-tools-np.io","env":"NonProd"}'
# prod
cf cups phoenix-home -p '{"alias":"phoenix-home","value":"phoenix-tools.io","env":"Prod"}'
```

### Adding a service to `window.phoenix.serviceBindings`

The service bindings property is a map of aliases and urls, relative to the current environment. By default, it's populated with values for all core Phoenix microservices (e.g. preferences, messaging, etc).

If you wish to add your own service to the middleware, first create a binding for that service in cloudfoundry.

#### Creating the CloudFoundry Binding

The following command will add a service binding called `example-url`, that points to the url: `https://example.phoenix-tools.io`
``` bash
cf cups example-url -p '{"alias":"example-url","url":"https://example.phoenix-tools.io"}'
```
**Note the structure of the binding:** The middleware will only use service bindings that have a key of **`url`** or **`value`**. Everything else is stripped. This should prevent you from accidentally sending client ids, secrets, or other private values to the UI.

(If using cf-deploy, be sure to add that service binding to your `cf-deploy.js` file.)

#### Add the binding to your middleware

To ensure the value is present as part of local development, add the value to the service bindings middleware:

``` javascript
const defaultBindings = {
  'example-url': { url: 'http://example.phoenix-tools-np.io' }
};

app.use(`${appBaseUrl}/service-bindings`, serviceBindings(defaultBindings))
```

### Protecting Secrets and Sensitive Values
To ensure that sensitive info like secret keys are not exposed to all clients, **only services with 'value' or 'url' properties will be exposed.**

For example - the following binding will be sent to the UI:
``` bash
cf cups example-setting -p '{"alias":"example-settings", "value":"will be exposed"}'
```
As it uses the "`value`" key.

This binding will be completely stripped from the results:
``` bash
cf cups example-setting -p '{"alias":"example-settings", "secretKey":"will not be exposed"}'
```
As neither `value` nor `url` are present.

This binding will strip the credentials, but use the url:
``` bash
cf cups example-setting -p '{"alias":"example-settings", "url":"example.phoenix-tools-np.io","secretKey":"will not be exposed"}'
```
As the key `url` is present.

### Bindings with aliases
This library also looks at the `alias` property. If present, the alias is treated as the binding's name. If absent, the binding name is used:

#### Example:

The following will be given the name `example-url`, as the alias property is missing
``` bash
cf cups example-url -p '{"url":"https://example.phoenix-tools.io"}'
```

The following will be given the name `aliased-name`, as the alias property is present
``` bash
cf cups example-url -p '{"alias": "aliased-name", "url":"https://example.phoenix-tools.io"}'
```

**We strongly recommend using an alias**, so you can update a binding's value without changing the code itself.

### Flags, and additional properties

Additional properties can be added to the `window.phoenix` object as well. These are passed in as the second argument when setting up the service bindings route.

``` javascript
const serviceBindings = require('@monsantoit/phoenix-service-bindings-middleware')
const extra = { key1: 'value1', key2: 'value2' }

app.use(`${appBaseUrl}/service-bindings`, serviceBindings(defaultBindings, extra));

// on the UI side, becomes...
window.phoenix = {
    key1: 'value1',
    key2: 'value2',
    localDevelopment: true,
    localOcelot: true,
    environment: nonProd,
    serviceBindings: {
        "home-url": "https://phoenix-tools-np.io/home",
        "preferences-url": "https://preferences.phoenix-tools-np.io",
        "navigation-url": "https://navigation.phoenix-tools-np.io",
        "messaging-url": "https://messaging.phoenix-tools-np.io",
        "profile-url": "https://profile.phoenix-tools-np.io",
        "user-feedback-url": "https://user-feedback.phoenix-tools-np.io",
        "example-url":"https://example.phoenix-tools-np.io"
    }
}
```

### Server Side Rendering

To access the bindings on the server-side for rendering, assign the results of `getBindings` to a global:

``` javascript
const serviceBindings = require('@monsantoit/phoenix-service-bindings-middleware')
global.phoenix = serviceBindings.getBindings(defaultBindings, extra, options)
```

## Recent Changelog

- **2.1.0** - Will now use name if alias does not exist for the service binding

- **3.0.0** - 02/13/19 The localOcelot flag is set to `true` by default when running locally - this will change the behavior of the profile client, so we're marking it as a breaking change.

- **3.0.1** - 02/27/19 - provided flags now override default values, as expected.

- **3.1.0** - 08/21/19 - catches missing phoenix bindings based on cf-services, or user provided values.