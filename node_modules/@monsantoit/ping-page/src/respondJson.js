const some = require('lodash.some')

const respondJson = (res, packageJson, smokeTestResults, startTime) => {
    const {name, version} = packageJson

    const results = smokeTestResults.map((result) => {
        const {url, response, error} = result
        const responseStatus = response ? response.status : undefined
        const errorStatus = error ? error.code : undefined

        const status = responseStatus || errorStatus || 'unknown'
        return {url, status}
    })

    const status = some(results, (result) => result.status !== 200) ? 500 : 200

    results.forEach((result, index) => {
        if (result.status !== 200) {
            console.error(index, result)
        }
    })

    const data = {name, version, startTime, results}
    return res
        .set('Content-Type', 'application/json')
        .status(status)
        .json(data)
}

module.exports = respondJson
