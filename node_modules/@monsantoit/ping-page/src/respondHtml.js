const some = require('lodash.some')

const processResult = (result) => {
    const {url, response, error} = result

    const urlHtml = (message, style = '') =>
        `\
<li>
   ${url} [<span style="${style}">${message}</span>]
</li>\
`
    const responseStatus = response ? response.status : undefined
    const errorStatus = error ? error.code : undefined

    const status = responseStatus || errorStatus || 'unknown'
    const html = error ? urlHtml(status, 'color:red;') : urlHtml('OK')
    return {status, html}
}

const respondHtml = (res, packageJson, smokeTestResults, startTime) => {
    const {name, version} = packageJson

    const results = smokeTestResults.map(processResult)
    const resultsHtml = results.map((result) => result.html).join('\n')
    const html = `\
<!DOCTYPE html>
<html>
    <head>
        <title>${name}</title>
        <meta charset='UTF-8'>
        <meta http-equiv='X-UA-Compatible' content='IE=edge'>
        <meta name='viewport' content='width=device-width, initial-scale=1'>
        <link rel='stylesheet'
              href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/css/bootstrap.min.css'
              type='text/css'>
        <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
        <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js'></script>
        <style>
        .row .property-label {
        font-weight: bold;
        }
        .results-row {
            margin-top: 10px;
        }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="page-header">
                <h3>${name} <small>build properties</small></h3>
            </div>
            <div class="row">
                <div class="col-md-2 property-label">version:</div>
                <div class="col-md-3">${version}</div>
            </div>
            <div class="row">
                <div class="col-md-2 property-label">start time:</div>
                <div id="formattedTimestamp" class="col-md-3">&nbsp;</div>
            </div>
            <div class="row results-row">
                <div class="col-md-5">
                    <ul>
                        ${resultsHtml}
                    </ul>
                </div>
            </div>
        </div>
        <script type="text/javascript">
            $('#formattedTimestamp').text(moment(${startTime}).format('YYYY-MMM-DD hh:mm:ss A Z'));
        </script>

    </body>
</html>\
`

    const status = some(results, (result) => result.status !== 200) ? 500 : 200

    results.forEach((result, index) => {
        if (result.status !== 200) {
            console.error(index, result)
        }
    })

    return res.status(status).send(html)
}

module.exports = respondHtml
