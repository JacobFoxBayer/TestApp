/* eslint-disable global-require */
const browser = require('./safe/browser')
const debug = require('./debug')

module.exports = (query, variables = {}) => {
    debug.log('queryProfile', typeof query === 'function' ? query() : undefined, variables)
    const {agent} = module.exports.dependencies
    const bindings = browser.serviceBindings()
    const profileUrl = bindings['profile-url']
    const payload = typeof query === 'function' ? query() : {query, variables}

    return agent
        .post(`${profileUrl}/v3/graphql`)
        .set('content-type', 'application/json')
        .send(payload)
        .then((rs) => {
            if (!rs.body) {
                debug.log('queryProfile: no body')
                throw new Error(
                    'profileClient.queryProfile - Unknown response from the Profile API. Is auth token support enabled? https://github.platforms.engineering/Velocity/profile-client#auth-token-support'
                )
            } else if (rs.body.errors) {
                debug.log('queryProfile: failed', rs.body)
                throw rs.body.errors
            } else {
                debug.log('queryProfile: success', rs.body)
                return rs.body.data
            }
        })
}

module.exports.dependencies = {
    agent: require('./agent')
}
