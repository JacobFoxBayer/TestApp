"use strict";

/* eslint-disable global-require */
var browser = require('./safe/browser');

var debug = require('./debug');

module.exports = function (query) {
  var variables = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
  debug.log('queryProfile', typeof query === 'function' ? query() : undefined, variables);
  var agent = module.exports.dependencies.agent;
  var bindings = browser.serviceBindings();
  var profileUrl = bindings['profile-url'];
  var payload = typeof query === 'function' ? query() : {
    query: query,
    variables: variables
  };
  return agent.post("".concat(profileUrl, "/v3/graphql")).set('content-type', 'application/json').send(payload).then(function (rs) {
    if (!rs.body) {
      debug.log('queryProfile: no body');
      throw new Error('profileClient.queryProfile - Unknown response from the Profile API. Is auth token support enabled? https://github.platforms.engineering/Velocity/profile-client#auth-token-support');
    } else if (rs.body.errors) {
      debug.log('queryProfile: failed', rs.body);
      throw rs.body.errors;
    } else {
      debug.log('queryProfile: success', rs.body);
      return rs.body.data;
    }
  });
};

module.exports.dependencies = {
  agent: require('./agent')
};