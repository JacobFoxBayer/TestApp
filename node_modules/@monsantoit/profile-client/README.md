# Velocity Profile Security Client

This library is **browser-only** - it does not run on the server.  It's meant to be used in conjunction with
[service bindings](https://github.platforms.engineering/Velocity/service-bindings)

For best results user service bindings 2.2.0 or later.

[View Changelog](#changelog)


## About client-side security

It's neither possible nor desirable to enforce a security policy in the browser.  At best, one could obfuscate the source code to deter
the amateur hacker.  This library should be used to enhance usability only.  Your services should be properly secured.

## Usage Examples

## Canned User Queries

The library includes a number of pre-defined queries commonly ran against the Profile API:

* `currentUser()` - returns basic user information for the current user
* `currentUserWithEntitlements(appId)` - returns basic user information along with entitlements the current user has for a given application
* `usersByIdWithEntitlements` - returns basic user information (including entitlements) for a specified list of users

This example uses `currentUserWithEntitlements` to fetch entitlements and check that the user has a specific entitlement:

```ecmascript 6
import {queries, queryProfile} from '@monsantoit/profile-client'

queryProfile(queries.currentUserWithEntitlements('MY-APP-ID'))
.then(rs => rs.getCurrentUser.entitlements.some(e => e.code === 'SUPER-USER'))
.then((isSuperUser) => {
    if(isSuperUser) {
        //
    }
})
```

## Custom Queries

In addition to the pre-defined queries provided, applications can design and run their own queries.  Please [read the API docs](https://profile.velocity-np.ag/v3/docs/) before writing your query.  The docs also have an editor for building and testing your query.

This example fetches the current user's manager:

```ecmascript 6
import {queryProfile} from '@monsantoit/profile-client'

const query = `{
    getCurrentUser {
        manager {
            id
            preferredName {
                full
            }
        }
    }
} `

queryProfile(query)
.then(rs => {
    console.log(rs.getCurrentUser.manager.id, rs.getCurrentUser.manager.preferredName.full)
})

```

## Auth token support

Auth token support is **automatically enabled** by the [velocity navbar](https://github.com/MonsantoCo/velocity-navbar).  Your client-side
ajax requests will use the auth token.

The auth token is refreshed automatically so that users can be logged into your application for longer than two hours. The refresh can be disabled to support automated testing in live environments by setting `window.velocity.enableRefresh=false`.

### Preconfigured [superagent](https://github.com/visionmedia/superagent) proxy

The easiest way to use the auth token support is with the promisified agent module:

``` javascript
// snip navbar example - see navbar README
import {agent} from '@monsantoit/profile-client'

// returned promise is resolved when auth header support is enabled
Navbar.install(props, document.querySelector('.nav'))
.then(() => {
    // obviously you wouldn't use a literal URL like this
    // sets the auth header automatically
    agent.get('https://my-api.velocity-np.ag/v1/foo')
    .then(({body}) => renderUi(body))
})
```

### Using `enableAuthTokenSupport` and `getAuthHeader`

You can use these functions directly if needed:

``` javascript
import {Promise} from 'es6-promise'
import superagent from 'superagent'
import superagentPromise from 'superagent-promise'
import {enableAuthTokenSupport, getAuthHeader} from '@monsantoit/profile-client'

const agent = superagentPromise(superagent, Promise)

// init auth token support before doing ajax
enableAuthTokenSupport()
.then(() => {
    agent.get('https://my-api.velocity-np.ag/v1/foo')
    // for local development support with cookies - does not work in Safari
    .withCredentials()
    .set(getAuthHeader())
    .then(({body}) => renderUi(body))
})
```

### Debug Mode / Verbose Logging
The most common use of the profile client is handling auth flow.

The profile client is bundled into the navbar, which is bundled into your app, which runs a loop to maintain a valid token. Debugging auth and token problems can get a little complex, so we've added a flag to enable verbose logging.

#### Enable debug mode in Velocity Environment
```
window.velocity.debugProfileClient = true
```

Or pass `{debugProfileClient: true}` into your instance of [`@monsantoit/velocity-service-bindings`](https://github.platforms.engineering/Velocity/service-bindings/)

#### Enable debug mode in Phoenix Environment
```
window.phoenix.debugProfileClient = true
```

Or pass `{debugProfileClient: true}` into your instance of [`@monsantoit/phoenix-service-bindings-middleware`]((https://github.platforms.engineering/Phoenix/service-bindings-middleware)


---

## CHANGELOG

### 03/17/2022
- Version 4.2.1
- Updated dependencies and devDependencies for `npm audit` issues

### 08/01/2018
- Version 4.x
- Removed all deprecated functions and their documentation
- All remaining functionality calls PAPI v3 API only

### 02/13/2017
- Version 3.4.x
- Added namespace control
- Added verbose logging mode
- cleanup use of servicebindings globals

### 12/19/2017
- Version 3.3.3
- upgraded superagent for security patch

### 12/4/2017
- Version 3.2.0 - 3.3.2
- Adds configuration to disabled Automatic Refresh for acceptance testing
- Fixed possible undefined bug for `window.velocity`

### 11/20/2017
- Version 3.1.0
- add functionality to grab a token from cookies, as part of configuration.
- replace setTimeout to setInterval, checking for expiration more often and more reliably.

### 10/31/2017
- Version 3.0.5
- Fix window.velocity bug that would initialize a Velocity app without an auth token.

### 10/20/2017
- Version 3.0.4
- Added v3 Profile API support, and `queryProfile` functionality.
